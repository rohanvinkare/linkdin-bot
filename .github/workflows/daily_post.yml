name: LinkedIn Auto-Poster (Concept-First Strategy)

on:
  schedule:
    # MORNING POST: 09:30 AM IST (04:00 UTC)
    - cron: '0 4 * * *'
    
    # EVENING POST: 05:30 PM IST (12:00 UTC)
    - cron: '0 12 * * *'
    
  workflow_dispatch: # Manual trigger for testing

permissions:
  contents: write # Required to commit history.json

jobs:
  post-to-linkedin:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone for faster checkout
      
      - name: ðŸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Cache pip dependencies for faster runs
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install requests feedparser beautifulsoup4 lxml
      
      - name: ðŸ” Verify Secrets (without exposing values)
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.LINKEDIN_TOKEN }}" ]; then
            echo "âŒ LINKEDIN_TOKEN is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.LINKEDIN_URN }}" ]; then
            echo "âŒ LINKEDIN_URN is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "âŒ GEMINI_API_KEY is missing!"
            exit 1
          fi
          echo "âœ… All secrets are configured"
      
      - name: ðŸ¤– Run LinkedIn Bot
        env:
          LINKEDIN_TOKEN: ${{ secrets.LINKEDIN_TOKEN }}
          LINKEDIN_URN: ${{ secrets.LINKEDIN_URN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸš€ Starting bot execution..."
          python linkedin_bot_improved.py
          
          # Check if the script succeeded
          if [ $? -eq 0 ]; then
            echo "âœ… Bot completed successfully"
          else
            echo "âŒ Bot execution failed"
            exit 1
          fi
      
      - name: ðŸ’¾ Commit History Updates
        run: |
          git config --local user.name 'LinkedIn Bot'
          git config --local user.email 'bot@linkedin-automation.local'
          
          # Add history.json if it exists and has changes
          if [ -f history.json ]; then
            git add history.json
            
            # Only commit if there are actual changes
            if git diff --staged --quiet; then
              echo "â„¹ï¸ No changes to history.json"
            else
              git commit -m "ðŸ“ Update post history [$(date +'%Y-%m-%d %H:%M UTC')] [skip ci]"
              git push
              echo "âœ… History updated and pushed"
            fi
          else
            echo "âš ï¸ history.json not found - skipping commit"
          fi
      
      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          echo "## LinkedIn Bot Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f history.json ]; then
            TOTAL_POSTS=$(jq '. | length' history.json 2>/dev/null || echo "N/A")
            echo "- **Total Posts in History:** $TOTAL_POSTS" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi